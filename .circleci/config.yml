# CircleCI Configuration for E-Commerce Platform
# Demonstrating Adaptive Testing Capabilities

version: 2.1

# Orbs are reusable packages of CircleCI configuration
orbs:
  node: circleci/node@5.1.0

# Define reusable executors
executors:
  node-executor:
    docker:
      - image: cimg/node:18.19
      - image: cimg/postgres:15.5
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ecommerce_test_db
      - image: redis:7.2
    working_directory: ~/project
    resource_class: medium

# Define reusable commands
commands:
  install_dependencies:
    description: "Install Node dependencies with caching"
    steps:
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            - v1-dependencies-
      - run:
          name: Install Dependencies
          command: npm ci
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}

  wait_for_db:
    description: "Wait for PostgreSQL to be ready"
    steps:
      - run:
          name: Wait for PostgreSQL
          command: |
            dockerize -wait tcp://localhost:5432 -timeout 1m

# Define jobs
jobs:
  # Job 1: Checkout and install dependencies
  checkout_and_install:
    executor: node-executor
    steps:
      - checkout
      - install_dependencies
      - persist_to_workspace:
          root: ~/project
          paths:
            - .

  # Job 2: Lint and type check
  lint_and_typecheck:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run ESLint
          command: npm run lint
      - run:
          name: Run TypeScript type check
          command: npm run typecheck

  # Job 3: Run unit tests WITHOUT adaptive testing (baseline)
  test_unit_baseline:
    executor: node-executor
    parallelism: 1
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run Unit Tests (Baseline)
          command: |
            npm run test:unit -- --coverage --maxWorkers=2
          environment:
            JEST_JUNIT_OUTPUT_DIR: test-results/jest
            JEST_JUNIT_OUTPUT_NAME: results.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-baseline

  # Job 4: Run unit tests WITH adaptive testing
  test_unit_adaptive:
    executor: node-executor
    parallelism: 4  # Split across 4 nodes
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run Unit Tests (Adaptive - Split by Timing)
          command: |
            # Use CircleCI test splitting
            TESTFILES=$(circleci tests glob "src/**/*.spec.ts" | circleci tests split --split-by=timings)
            npm test -- --ci --maxWorkers=2 --testPathPattern="$(echo $TESTFILES | tr ' ' '|')"
          environment:
            JEST_JUNIT_OUTPUT_DIR: test-results/jest
            JEST_JUNIT_OUTPUT_NAME: results.xml
      - store_test_results:
          path: test-results

  # Job 5: Run integration tests
  test_integration:
    executor: node-executor
    parallelism: 2
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Run Integration Tests
          command: |
            TESTFILES=$(circleci tests glob "tests/integration/**/*.test.ts" | circleci tests split --split-by=timings)
            npm test -- --ci --testPathPattern="$(echo $TESTFILES | tr ' ' '|')"
          environment:
            DB_HOST: localhost
            DB_PORT: 5432
            DB_NAME: ecommerce_test_db
            DB_USER: postgres
            DB_PASSWORD: postgres
            REDIS_HOST: localhost
            REDIS_PORT: 6379
      - store_test_results:
          path: test-results

  # Job 6: Run E2E tests
  test_e2e:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Seed Test Data
          command: npm run db:seed
      - run:
          name: Run E2E Tests
          command: npm run test:e2e -- --ci
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results/screenshots
          destination: e2e-screenshots

  # Job 7: Run performance tests
  test_performance:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Performance Tests
          command: npm run test:performance -- --ci
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results/performance
          destination: performance-reports

  # Job 8: Build application
  build:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Build TypeScript
          command: npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - dist

  # Job 9: Generate coverage report
  coverage_report:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Generate Combined Coverage Report
          command: npm run test:coverage -- --ci
      - run:
          name: Upload Coverage to Codecov
          command: |
            # Install codecov
            npm install -g codecov
            # Upload coverage
            codecov
      - store_artifacts:
          path: coverage
          destination: coverage-final

  # Job 10: ADAPTIVE TESTING - Unit Tests (Intelligent Test Selection)
  # NOTE: Requires CircleCI Adaptive Testing preview feature to be enabled
  # Request access: https://circleci.com/docs/guides/test/adaptive-testing/
  test_unit_adaptive_intelligent:
    executor: node-executor
    parallelism: 4
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Run Unit Tests (Adaptive - Intelligent Selection)
          command: |
            # ADAPTIVE TESTING: Runs ONLY impacted tests based on code changes
            # Uses test impact analysis from .circleci/test-suites.yml
            circleci run testsuite "unit-tests"
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-unit

  # Job 11: ADAPTIVE TESTING - Integration Tests (Intelligent Test Selection)
  # NOTE: Requires CircleCI Adaptive Testing preview feature to be enabled
  test_integration_adaptive_intelligent:
    executor: node-executor
    parallelism: 2
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Run Integration Tests (Adaptive - Intelligent Selection)
          command: |
            # ADAPTIVE TESTING: Runs ONLY impacted tests based on code changes
            # Uses test impact analysis from .circleci/test-suites.yml
            circleci run testsuite "integration-tests"
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-adaptive-integration

  # Job 12: ADAPTIVE TESTING - E2E Tests (Intelligent Test Selection)
  # NOTE: Requires CircleCI Adaptive Testing preview feature to be enabled
  test_e2e_adaptive_intelligent:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project
      - wait_for_db
      - run:
          name: Run Database Migrations
          command: npm run db:migrate
      - run:
          name: Seed Test Data
          command: npm run db:seed
      - run:
          name: Run E2E Tests (Adaptive - Intelligent Selection)
          command: |
            # ADAPTIVE TESTING: Runs ONLY impacted tests based on code changes
            # Uses test impact analysis from .circleci/test-suites.yml
            circleci run testsuite "e2e-tests"
      - store_test_results:
          path: test-results

# Define workflows
workflows:
  version: 2

  # Main workflow WITHOUT adaptive testing (baseline for comparison)
  test_baseline:
    jobs:
      - checkout_and_install:
          filters:
            branches:
              only: main
      - lint_and_typecheck:
          requires:
            - checkout_and_install
      - test_unit_baseline:
          requires:
            - lint_and_typecheck
      - test_integration:
          requires:
            - test_unit_baseline
      - test_e2e:
          requires:
            - test_integration
      - test_performance:
          requires:
            - test_integration
      - build:
          requires:
            - test_e2e
            - test_performance
      - coverage_report:
          requires:
            - build

  # Workflow WITH adaptive testing (optimized)
  test_adaptive:
    jobs:
      - checkout_and_install:
          filters:
            branches:
              ignore: main
      - lint_and_typecheck:
          requires:
            - checkout_and_install
      - test_unit_adaptive:
          requires:
            - lint_and_typecheck
      - test_integration:
          requires:
            - test_unit_adaptive
      - test_e2e:
          requires:
            - test_integration
      - build:
          requires:
            - test_e2e

  # Nightly comprehensive test run
  nightly_full_suite:
    triggers:
      - schedule:
          cron: "0 0 * * *"  # Run at midnight UTC
          filters:
            branches:
              only: main
    jobs:
      - checkout_and_install
      - lint_and_typecheck:
          requires:
            - checkout_and_install
      - test_unit_adaptive:
          requires:
            - lint_and_typecheck
      - test_integration:
          requires:
            - test_unit_adaptive
      - test_e2e:
          requires:
            - test_integration
      - test_performance:
          requires:
            - test_integration
      - coverage_report:
          requires:
            - test_e2e
            - test_performance

  # NEW: Workflow WITH INTELLIGENT ADAPTIVE TESTING
  # This workflow uses CircleCI's test impact analysis to run ONLY impacted tests
  # Significantly faster than running all tests on every commit
  test_adaptive_intelligent:
    jobs:
      - checkout_and_install:
          filters:
            branches:
              only: adaptive-testing-demo
      - lint_and_typecheck:
          requires:
            - checkout_and_install
      - test_unit_adaptive_intelligent:
          requires:
            - lint_and_typecheck
      - test_integration_adaptive_intelligent:
          requires:
            - test_unit_adaptive_intelligent
      - test_e2e_adaptive_intelligent:
          requires:
            - test_integration_adaptive_intelligent
      - build:
          requires:
            - test_e2e_adaptive_intelligent
